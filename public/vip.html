<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dray Source</title>
    <link rel="stylesheet" href="css/style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>

<body>
    <header class="Header">
        <div class="header-container">
            <div class="item"> <span id="electronic" class="money-color">0</span> <br> Electronic </div>
            <div class="item"><span class="money-color" id="money">0</span> <br> Currency </div>
        </div>
    </header>
    <main>
        <div class="main-container">
            <div class="second-main-container">
                <div class="item box" data-cost="9000">
                    <h2 class="package-title"><i class='bx bx-candles' style='color:gold'></i>Reliable Investmant<i
                            class='bx bx-candles' style='color:gold'></i></h2>
                    <p class="rank-buying">Copper Investmant</p>
                    <div class="buying-details">
                        <div class="info">Max 300<br><span class="details">Daily limit</span></div>
                        <div class="info">90 Days <br><span class="details">Expire Time</span></div>
                        <div class="info">  0.1 Babyln-coin  <br><span class="details">Working income</span></div>
                    </div>
                    <div class="items click"><a href="#">90 USDT Open now</a></div>
                </div>
                <div class="item1 box" data-cost="18000">
                    <p class="rank-buying">Eridu Investmant</p>
                    <div class="buying-details">
                        <div class="info">Max 300 <br><span class="details">Daily limit</span></div>
                        <div class="info">90 Days <br><span class="details">Expire Time</span></div>
                        <div class="info">0.2 Babyln-coin <br><span class="details">Working income</span></div>
                    </div>
                    <div class="items click"><a href="#">180 USDT Open now</a></div>
                </div>
                <div class="item2 box" data-cost="30000">
                    <p class="rank-buying">Amber Investmant</p>
                    <div class="buying-details">
                        <div class="info">Max 200 <br><span class="details">Daily limit</span></div>
                        <div class="info">90 Days <br><span class="details">Expire Time</span></div>
                        <div class="info">0.5 Babyln-coin <br><span class="details">Working income</span></div>
                    </div>
                    <div class="items click"><a href="#">300 USDT Open now</a></div>
                </div>
                <div class="item3 box" data-cost="60000">
                    <p class="rank-buying">Sumeru Investmant</p>
                    <div class="buying-details">
                        <div class="info">Max 200 <br><span class="details">Daily limit</span></div>
                        <div class="info">90 Days <br><span class="details">Expire Time</span></div>
                        <div class="info">0.10 Babyln-coin <br><span class="details">Working income <br>
                                Comeing soon</span></div>
                    </div>
                    <div class="items click"><a href="#">600 USDT Open now</a></div>
                </div>
                <div class="item4 box" data-cost="80000">
                    <p class="rank-buying">Tritium Investmant</p>
                    <div class="buying-details">
                        <div class="info">Max 26 <br><span class="details">Daily limit</span></div>
                        <div class="info">90 Days <br><span class="details">Expire Time</span></div>
                        <div class="info">1.01 USDT-cent<br><span class="details">Working income<br>
                                Comeing soon</span></div>
                    </div>
                    <div class="items click"><a href="#">800 USDT Open now</a></div>
                </div>
                <div class="item4 box" data-cost="100000">
                    <p class="rank-buying">Incense Investmant</p>
                    <div class="buying-details">
                        <div class="info">Max 33 <br><span class="details">Daily limit</span></div>
                        <div class="info">90 Days <br><span class="details">Expire Time</span></div>
                        <div class="info">1.01 Babyln-coin <br><span class="details">Working income <br>
                                Comeing soon</span></div>
                    </div>
                    <div class="items click"><a href="#">1000 USDT Open now</a></div>
                </div>
  <div class="item5 box" data-cost="120000">
                    <p class="rank-buying">Ziggurat Investmant</p>
                    <div class="buying-details">
                        <div class="info">Max 40 <br><span class="details">Daily limit</span></div>
                        <div class="info">90 Days <br><span class="details">Expire Time</span></div>
                        <div class="info">1 Babyln-coin <br><span class="details">Working income <br>
                                Comeing soon</span></div>
                    </div>
                    <div class="items click"><a href="#">1200 USDT Open now</a></div>
                </div>
  <div class="item6 box" data-cost="140000">
                    <p class="rank-buying">Etemenanki Investmant</p>
                    <div class="buying-details">
                        <div class="info">Max 46 <br><span class="details">Daily limit</span></div>
                        <div class="info">90 Days <br><span class="details">Expire Time</span></div>
                        <div class="info">1.01 USDT-cent<br><span class="details">Working income <br>
                                Comeing soon</span></div>
                    </div>
                    <div class="items click"><a href="#">1400 USDT Open now</a></div>
                </div>
<div class="item7 box" data-cost="160000">
                    <p class="rank-buying">Lugal Investmant</p>
                    <div class="buying-details">
                        <div class="info">Max 53 <br><span class="details">Daily limit</span></div>
                        <div class="info">90 Days <br><span class="details">Expire Time</span></div>
                        <div class="info">1.01 Babyln-coin <br><span class="details">Working income <br>
                                Comeing soon</span></div>
                    </div>
                    <div class="items click"><a href="#">1600 USDT Open now</a></div>
                </div>
<div class="item8 box" data-cost="180000">
                    <p class="rank-buying">Tigris Investmant</p>
                    <div class="buying-details">
                        <div class="info">Max 60 <br><span class="details">Daily limit</span></div>
                        <div class="info">90 Days <br><span class="details">Expire Time</span></div>
                        <div class="info">1 Babyln-coin <br><span class="details">Working income <br>
                                Comeing soon</span></div>
                    </div>
                    <div class="items click"><a href="#">1800 USDT Open now</a></div>
                </div>

                <div class="item9 box" style="margin-bottom: 8.5vh;" data-cost="200000">
                    <p class="rank-buying">Babylon Investmant (Mega Chance)</p>
                    <div class="buying-details">
                        <div class="info">Max 66 <br><span class="details">Daily limit</span></div>
                        <div class="info">90 Days <br><span class="details">Expire Time</span></div>
                        <div class="info">2 (2x) Babyln-coin <br><span class="details">Working income<br>
                                Comeing soon</span></div>
                    </div>
                    <div class="items click"><a href="#">2000 USDT Open now</a></div>
                </div>

            </div>

        </div>
    </main>
    <footer class="container">
        <nav class="container-layer">
            <a href="/Home" class="clk"> <i class='bx bxs-home' style='color:#0c0400'></i><br>Home</a>
            <a href="/Connection" class="clk"><i class='bx bx-sitemap' style='color:#0c0b0b'></i><br>Network</a>
            <a href="/vip" class="clk vip-link"><i class='bx bxl-sketch' style='color:#0c0c0c'></i> <br> Invest </a>
            <a href="/mine" class="clk"><i class='bx bxs-user' style='color:#000400'></i><br> Owner</a>
            <a href="/about" class="clk"><i class='bx bx-shield' style='color:#0c0b0b'></i><br>About</a>
        </nav>
    </footer>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const vipuserId = urlParams.get('vipuserId');
        const packageCost = parseInt(urlParams.get('packageCost'));

        // Fetch the latest user data from the server
        let userId = localStorage.getItem('userId');
        if (!userId) {
            alert('User information not found. Please log in again.');
            window.location.href = '/login';
        } else {
            // Fetch user details including score from the backend API
            fetch(`/user-data?userId=${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update localStorage with the latest user data
                        localStorage.setItem('score', data.score);
                        localStorage.setItem('totalWithdrawn', data.totalWithdrawn);

                        // Update frontend display with the latest data
                        updateMoneyDisplay(data.score, localStorage.getItem('electronic') || 0);
                    } else {
                        alert('Error fetching user data.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                });
        }

        let electronic = parseInt(localStorage.getItem('electronic')) || 0;
        let score = parseInt(localStorage.getItem('score')) || 0;
        updateMoneyDisplay(score, electronic);

        // Get opened packages from localStorage
        const openPackages = JSON.parse(localStorage.getItem('openPackages')) || [];
        if (vipuserId) {
            document.querySelectorAll('.click').forEach(box => {
                const cost = parseInt(box.closest('.box').getAttribute('data-cost'));
                const packageOpened = openPackages.find(pkg => pkg.packageCost === cost);

                if (packageOpened) {
                    fetchPackageStatus(vipuserId, cost, box, packageOpened);
                } else {
                    box.innerHTML = `<a href="#">${cost} USDT Open now</a>`;
                }
                box.addEventListener('click', async (event) => {
                    event.preventDefault();

                    if (packageOpened) {
                        const response = await fetch(`/check-package-status?userId=${vipuserId}&packageCost=${cost}`);
                        const data = await response.json();

                        if (data.error) {
                            alert('Error: ' + data.error);
                            return;
                        }

                        // If the package has expired (90 days passed), show an alert and prevent redirect
                        if (data.daysLeftFor90 <= 0) {
                            alert('This package has expired.');
                            return;
                        }

                        window.location.href = `/income?vipuserId=${vipuserId}&packageCost=${cost}&isTodayRiched=${data.isTodayRiched ? 'true' : 'false'}`;
                    } else {
                        // Rest of the code to handle package opening
                        if (electronic >= cost || score >= cost) {
                            showReferralPrompt(vipuserId, cost, async (success, referredUserId) => {
                                if (success) {
                                    if (electronic >= cost) {
                                        electronic -= cost;
                                        localStorage.setItem('electronic', electronic);
                                    } else {
                                        score -= cost;
                                        localStorage.setItem('score', score);
                                    }

                                    updateMoneyDisplay(score, electronic);

                                    const newPackage = { packageCost: cost, lastOpened: Date.now(), referredUserId };
                                    openPackages.push(newPackage);
                                    localStorage.setItem('openPackages', JSON.stringify(openPackages));

                                    await fetch('/save-opened-package', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            userId: vipuserId,
                                            packageCost: cost,
                                            referredUserId,
                                            updatedElectronic: Math.round(electronic / 100) // Adjust the electronic value
                                        })
                                    });
                                    window.location.href = `/income?vipuserId=${vipuserId}&packageCost=${cost}&isTodayRiched=false`;
                                }
                            });
                        } else {
                            alert('Insufficient funds to open this package.');
                        }
                    }
                });
            });
        }

        // Fetch package status and display daysLeftFor90 accordingly
        async function fetchPackageStatus(vipuserId, cost, box, packageOpened) {
            try {
                const response = await fetch(`/check-package-status?userId=${vipuserId}&packageCost=${cost}`);
                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                const daysLeftFor90 = data.daysLeftFor90;

                if (daysLeftFor90 > 0) {
                    box.innerHTML = `<p>Opened for you (${daysLeftFor90} days left)</p>`;
                } else {
                    // If the 90 days have passed, modify the button to prevent access to the income page
                    box.innerHTML = `<a href="#">${cost} USDT Open now</a>`;
                }
            } catch (error) {
                console.error('Error fetching package status:', error);
            }
        }

        function updateMoneyDisplay(score, electronic) {
            let scoreDollars = Math.floor(score / 100);
            let scoreCents = score % 100;
            document.getElementById('money').textContent = `${scoreDollars}.${scoreCents < 10 ? '0' + scoreCents : scoreCents}`;

            let electronicDollars = Math.floor(electronic / 100);
            let electronicCents = electronic % 100;
            document.getElementById('electronic').textContent = `${electronicDollars}.${electronicCents < 10 ? '0' + electronicCents : electronicCents}`;
        }

        function showReferralPrompt(vipuserId, cost, callback) {
            const referralPrompt = document.createElement('div');
            referralPrompt.innerHTML = `
            <div style="background-color: green; color: black; padding: 10px; border-radius: 5px; position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
                <span id="backIcon" style="cursor: pointer; color: white; font-weight: bold; float: right;">&#10006;</span>
                <p style="color: gold;">Referred User ID</p>
                <input type="text" style="color: black;" id="referredUserId" placeholder="Enter user ID">
                <button id="submitReferral" style="background: linear-gradient(to right, #ff7e5f, #feb47b); color: white;">Submit</button>
            </div>
        `;

            document.body.appendChild(referralPrompt);

            document.getElementById('backIcon').addEventListener('click', () => {
                referralPrompt.remove();
            });

            document.getElementById('submitReferral').addEventListener('click', async () => {
                const referredUserId = document.getElementById('referredUserId').value;

                if (referredUserId) {
                    if (referredUserId === vipuserId) {
                        alert('Owner user ID not able to get commission.');
                        return;
                    }

                    try {
                        const response = await fetch('/check-user-exists', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ referredUserId })
                        });

                        const data = await response.json();

                        if (!data.exists) {
                            alert('This user not found.');
                            return;
                        }

                        referralPrompt.innerHTML = '<p style="background-color: green; color: black;">Processing...</p>';

                        setTimeout(() => {
                            referralPrompt.remove();
                            callback(true, referredUserId);
                        }, 500);
                    } catch (error) {
                        console.error('Error checking referred user:', error);
                    }
                } else {
                    alert('Please enter a User ID.');
                    callback(false);
                }
            });
        }

        // Link to VIP user page
        document.querySelector('.vip-link').addEventListener('click', (event) => {
            event.preventDefault();
            const vipuserId = localStorage.getItem('userId');

            if (vipuserId) {
                window.location.href = `/vip?vipuserId=${vipuserId}`;
            } else {
                alert('Invalid user ID');
            }
        });
    }); 
</script>

    <!-- this code is working just chage this code for refresh showing score  <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const vipuserId = urlParams.get('vipuserId');
            const packageCost = parseInt(urlParams.get('packageCost'));
// Fetch the latest user data from the server
    let userId = localStorage.getItem('userId');
    if (!userId) {
        alert('User information not found. Please log in again.');
        window.location.href = '/login';
    } else {
        // Fetch user details including score from the backend API
        fetch(`/user-data?userId=${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update localStorage with the latest user data
                    localStorage.setItem('score', data.score);
                    // localStorage.setItem('electronic', data.electronic);
                    localStorage.setItem('totalWithdrawn', data.totalWithdrawn);

                    // Update frontend display with the latest data
                    displayUserData();
                } else {
                    alert('Error fetching user data.');
                }
            })
            .catch(error => {
                console.error('Error fetching user data:', error);
            });
    }
            let electronic = parseInt(localStorage.getItem('electronic')) || 0;
            let score = parseInt(localStorage.getItem('score')) || 0;
            updateMoneyDisplay(score, electronic);

            // Get opened packages from localStorage
            const openPackages = JSON.parse(localStorage.getItem('openPackages')) || [];
            if (vipuserId) {
                document.querySelectorAll('.click').forEach(box => {
                    const cost = parseInt(box.closest('.box').getAttribute('data-cost'));
                    const packageOpened = openPackages.find(pkg => pkg.packageCost === cost);

                    if (packageOpened) {
                        fetchPackageStatus(vipuserId, cost, box, packageOpened);
                    } else {
                        box.innerHTML = `<a href="#">${cost} USDT Open now</a>`;
                    }
                    box.addEventListener('click', async (event) => {
                        event.preventDefault();

                        if (packageOpened) {
                            const response = await fetch(`/check-package-status?userId=${vipuserId}&packageCost=${cost}`);
                            const data = await response.json();

                            if (data.error) {
                                alert('Error: ' + data.error);
                                return;
                            }

                            // If the package has expired (90 days passed), show an alert and prevent redirect
                            if (data.daysLeftFor90 <= 0) {
                                alert('This package has expired.');
                                return;
                            }

                            window.location.href = `/income?vipuserId=${vipuserId}&packageCost=${cost}&isTodayRiched=${data.isTodayRiched ? 'true' : 'false'}`;
                        } else {
                            // Rest of the code to handle package opening
                            if (electronic >= cost || score >= cost) {
                                showReferralPrompt(vipuserId, cost, async (success, referredUserId) => {
                                    if (success) {
                                        if (electronic >= cost) {
                                            electronic -= cost;
                                            localStorage.setItem('electronic', electronic);
                                        } else {
                                            score -= cost;
                                            localStorage.setItem('score', score);
                                        }

                                        updateMoneyDisplay(score, electronic);

                                        const newPackage = { packageCost: cost, lastOpened: Date.now(), referredUserId };
                                        openPackages.push(newPackage);
                                        localStorage.setItem('openPackages', JSON.stringify(openPackages));

                                        await fetch('/save-opened-package', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                                userId: vipuserId,
                                                packageCost: cost,
                                                referredUserId,
                                              updatedElectronic: Math.round(electronic / 100) // Adjust the electronic value// Make sure to pass the updated electronic value here
                                            })
                                        });
                                        window.location.href = `/income?vipuserId=${vipuserId}&packageCost=${cost}&isTodayRiched=false`;
                                    }
                                });
                            } else {
                                alert('Insufficient funds to open this package.');
                            }
                        }
                    });
                });
            }

            // Fetch package status and display daysLeftFor90 accordingly
            async function fetchPackageStatus(vipuserId, cost, box, packageOpened) {
                try {
                    const response = await fetch(`/check-package-status?userId=${vipuserId}&packageCost=${cost}`);
                    const data = await response.json();

                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }

                    const daysLeftFor90 = data.daysLeftFor90;

                    if (daysLeftFor90 > 0) {
                        box.innerHTML = `<p>Opened for you (${daysLeftFor90} days left)</p>`;
                    } else {
                        // If the 90 days have passed, modify the button to prevent access to the income page
                        box.innerHTML = `<a href="#">${cost} USDT Open now</a>`;
                    }
                } catch (error) {
                    console.error('Error fetching package status:', error);
                }
            }


            function updateMoneyDisplay(score, electronic) {
                let scoreDollars = Math.floor(score / 100);
                let scoreCents = score % 100;
                document.getElementById('money').textContent = `${scoreDollars}.${scoreCents < 10 ? '0' + scoreCents : scoreCents}`;

                let electronicDollars = Math.floor(electronic / 100);
                let electronicCents = electronic % 100;
                document.getElementById('electronic').textContent = `${electronicDollars}.${electronicCents < 10 ? '0' + electronicCents : electronicCents}`;
            }

            function showReferralPrompt(vipuserId, cost, callback) {
                const referralPrompt = document.createElement('div');
                referralPrompt.innerHTML = `
            <div style="background-color: green; color: black; padding: 10px; border-radius: 5px; position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
                <span id="backIcon" style="cursor: pointer; color: white; font-weight: bold; float: right;">&#10006;</span>
                <p style="color: gold;">Referred User ID</p>
                <input type="text" style="color: black;" id="referredUserId" placeholder="Enter user ID">
                <button id="submitReferral" style="background: linear-gradient(to right, #ff7e5f, #feb47b); color: white;">Submit</button>
            </div>
        `;

                document.body.appendChild(referralPrompt);

                document.getElementById('backIcon').addEventListener('click', () => {
                    referralPrompt.remove();
                });

                document.getElementById('submitReferral').addEventListener('click', async () => {
                    const referredUserId = document.getElementById('referredUserId').value;

                    if (referredUserId) {
                        if (referredUserId === vipuserId) {
                            alert('Owner user ID not able to get commission.');
                            return;
                        }

                        try {
                            const response = await fetch('/check-user-exists', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ referredUserId })
                            });

                            const data = await response.json();

                            if (!data.exists) {
                                alert('This user not found.');
                                return;
                            }

                            referralPrompt.innerHTML = '<p style="background-color: green; color: black;">Processing...</p>';

                            setTimeout(() => {
                                referralPrompt.remove();
                                callback(true, referredUserId);
                            }, 500);
                        } catch (error) {
                            console.error('Error checking referred user:', error);
                        }
                    } else {
                        alert('Please enter a User ID.');
                        callback(false);
                    }
                });
            }

            // Link to VIP user page
            document.querySelector('.vip-link').addEventListener('click', (event) => {
                event.preventDefault();
                const vipuserId = localStorage.getItem('userId');

                if (vipuserId) {
                    window.location.href = `/vip?vipuserId=${vipuserId}`;
                } else {
                    alert('Invalid user ID');
                }
            });
        }); 
    </script> -->

</body>

</html>